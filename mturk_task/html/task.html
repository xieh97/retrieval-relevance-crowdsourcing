<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>

<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>


<crowd-form>
    <div class="container">
        <!--  Instructions  -->
        <div class="row">
            <div class="col-sm-12 mb-sm-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <strong>Task Description</strong>
                    </div>

                    <div class="card-body pb-sm-0" style="background-color:#E6E6E6">

                        <p class="my-sm-1" style="text-align: justify">
                            In this task, you will be asked to assign numeric scores (between 0 and 100) to indicate your judgement of <strong><u>how much the content (i.e., sounds) of an audio segment matches a given description</u></strong>.
                            Please read the following instructions carefully before deciding whether to complete the task.
                        </p>

                        <ul>
                            <li>Read the text description, which describes some audio content (i.e., sounds).</li>
                            <li>Listen to the 5 audio segments, and judge how much their content (i.e., sounds in each segment) matches the given description.</li>
                            <li>Use a slider to select a number (between 0 and 100) for each segment, where
                                <ul>
                                    <li>100 indicates that the segment and the given description make <i><u>a perfect content matching</u></i>,</li>
                                    <li>0 indicates that the segment and the given description have <i><u>no content matching at all</u></i>.</li>
                                </ul>
                            </li>
                        </ul>

                        <p class="my-sm-1" style="text-align: justify">
                            The audio players will <i><u>not work</u></i> with Internet Explorer, and <i><u>do not</u></i> accept this task if you are using that browser or do this task with another browser.
                            All answers will be checked by human experts, and answers with low quality will be rejected.
                        </p>

                        <ul>
                            <li>You should listen to each audio segment entirely.</li>
                            <li>Please do this task in a quiet environment with headphones.</li>
                        </ul>

                    </div>
                </div>
            </div>
        </div>

        <!--  Task Assignment  -->
        <div class="row">
            <div class="col-sm-12 mb-sm-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <strong>Task Assignment</strong>
                    </div>

                    <div class="card-body">
                        <p class="card-text">Listen to the following five audio segments, and give scores to indicate how much their content (i.e., sounds in each segment) matches <strong><u>the given description</u></strong>:</p>

                        <input type="hidden" name="seq_no" value="${seq_no}" required/>
                        <input type="hidden" name="tid" value="${tid}" required/>
                        <input type="hidden" id="f1_played" name="f1_played" value=""/>
                        <input type="hidden" id="f2_played" name="f2_played" value=""/>
                        <input type="hidden" id="f3_played" name="f3_played" value=""/>
                        <input type="hidden" id="f4_played" name="f4_played" value=""/>
                        <input type="hidden" id="f5_played" name="f5_played" value=""/>

                        <div class="card mb-sm-3">
                            <div class="card-body">
                                <p class="card-text" style="text-align: center">
                                    <strong>${text}</strong>
                                </p>
                            </div>
                        </div>

                        <p class="my-sm-1" style="text-align: justify">
                            On a scale of 0 to 100, where
                        </p>

                        <ul>
                            <li>100 indicates that the segment and the given description make <i><u>a perfect content matching</u></i>,</li>
                            <li>0 indicates that the segment and the given description have <i><u>no content matching at all</u></i>.</li>
                        </ul>

                        <p class="card-text">
                            <strong><u>How much does the content of each audio segment match the given description?</u></strong>
                            Please listen to each audio segment entirely.
                        </p>

                        <div id="error_box"></div>

                        <div class="row mb-sm-3">
                            <div class="col-sm-4">
                                <div class="card">
                                    <div class="card-header">
                                        <strong>Audio Segment 1</strong>
                                    </div>
                                    <div class="card-body p-sm-2">
                                        <audio id="f1_audio" controls controlslist="nodownload noplaybackrate" style="width: 100%">
                                            <source src="https://mturk.pages.dev/assets/${split}/${f1}.wav" type="audio/wav">
                                            Your browser does not support the <code>audio</code> element.
                                        </audio>
                                    </div>
                                    <div class="card-footer py-sm-0 pe-sm-1 ps-sm-0">
                                        <crowd-slider id="f1_slider" name="f1" editable max="100" min="0" pin step="1" value="0" required style="width: auto"></crowd-slider>
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-4">
                                <div class="card">
                                    <div class="card-header">
                                        <strong>Audio Segment 2</strong>
                                    </div>
                                    <div class="card-body p-sm-2">
                                        <audio id="f2_audio" controls controlslist="nodownload noplaybackrate" style="width: 100%">
                                            <source src="https://mturk.pages.dev/assets/${split}/${f2}.wav" type="audio/wav">
                                            Your browser does not support the <code>audio</code> element.
                                        </audio>
                                    </div>
                                    <div class="card-footer py-sm-0 pe-sm-1 ps-sm-0">
                                        <crowd-slider id="f2_slider" name="f2" editable max="100" min="0" pin step="1" value="0" required style="width: auto"></crowd-slider>
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-4">
                                <div class="card">
                                    <div class="card-header">
                                        <strong>Audio Segment 3</strong>
                                    </div>
                                    <div class="card-body p-sm-2">
                                        <audio id="f3_audio" controls controlslist="nodownload noplaybackrate" style="width: 100%">
                                            <source src="https://mturk.pages.dev/assets/${split}/${f3}.wav" type="audio/wav">
                                            Your browser does not support the <code>audio</code> element.
                                        </audio>
                                    </div>
                                    <div class="card-footer py-sm-0 pe-sm-1 ps-sm-0">
                                        <crowd-slider id="f3_slider" name="f3" editable max="100" min="0" pin step="1" value="0" required style="width: auto"></crowd-slider>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-4">
                                <div class="card">
                                    <div class="card-header">
                                        <strong>Audio Segment 4</strong>
                                    </div>
                                    <div class="card-body p-sm-2">
                                        <audio id="f4_audio" controls controlslist="nodownload noplaybackrate" style="width: 100%">
                                            <source src="https://mturk.pages.dev/assets/${split}/${f4}.wav" type="audio/wav">
                                            Your browser does not support the <code>audio</code> element.
                                        </audio>
                                    </div>
                                    <div class="card-footer py-sm-0 pe-sm-1 ps-sm-0">
                                        <crowd-slider id="f4_slider" name="f4" editable max="100" min="0" pin step="1" value="0" required style="width: auto"></crowd-slider>
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-4">
                                <div class="card">
                                    <div class="card-header">
                                        <strong>Audio Segment 5</strong>
                                    </div>
                                    <div class="card-body p-sm-2">
                                        <audio id="f5_audio" controls controlslist="nodownload noplaybackrate" style="width: 100%">
                                            <source src="https://mturk.pages.dev/assets/${split}/${f5}.wav" type="audio/wav">
                                            Your browser does not support the <code>audio</code> element.
                                        </audio>
                                    </div>
                                    <div class="card-footer py-sm-0 pe-sm-1 ps-sm-0">
                                        <crowd-slider id="f5_slider" name="f5" editable max="100" min="0" pin step="1" value="0" required style="width: auto"></crowd-slider>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--  Feedback  -->
        <div class="row">
            <div class="col-sm-12 mb-sm-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <strong>Feedback (not obligatory)</strong>
                    </div>
                    <div class="card-body">
                        <textarea placeholder="Please tell us if there is some way we could improve this task."
                                  class="form-control" cols="250" name="feedback" maxlength="1000" rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12 mb-sm-3">
                <div class="d-flex justify-content-center">
                    <crowd-button form-action="submit" variant="primary">Submit</crowd-button>
                </div>
            </div>
        </div>
    </div>
</crowd-form>

<script>
    function audio_control(aid) {
        let audio = document.getElementById(aid + '_audio');
        audio.isPlayed = false;
        audio.addEventListener('play', function () {
            for (let elem of document.getElementsByTagName('audio')) {
                if (elem.id !== audio.id) {
                    elem.pause();
                }
            }
            audio.isPlayed = true;
            audio.play();
        });
    }

    audio_control('f1');
    audio_control('f2');
    audio_control('f3');
    audio_control('f4');
    audio_control('f5');

    function audio_check(aid) {
        let audio = document.getElementById(aid + '_audio');

        let played = 0.0;
        for (let i = 0; i < audio.played.length; i++) {
            played += (audio.played.end(i) - audio.played.start(i));
        }

        return !isNaN(audio.duration) && audio.isPlayed && played >= 5.0;
    }

    function audio_played(aid) {
        let audio = document.getElementById(aid + '_audio');
        let played = [];
        for (let i = 0; i < audio.played.length; i++) {
            played[i] = {start: audio.played.start(i), end: audio.played.end(i)};
        }
        return JSON.stringify(played);
    }

    document.querySelector('crowd-form').addEventListener('submit', function (event) {
        let isValid = true, trackId = NaN;

        if (!audio_check('f1')) {
            isValid = false;
            trackId = 1;
        } else if (!audio_check('f2')) {
            isValid = false;
            trackId = 2;
        } else if (!audio_check('f3')) {
            isValid = false;
            trackId = 3;
        } else if (!audio_check('f4')) {
            isValid = false;
            trackId = 4;
        } else if (!audio_check('f5')) {
            isValid = false;
            trackId = 5;
        }

        if (!isValid) {
            event.preventDefault();
            document.getElementById('error_box').className = 'alert alert-danger';
            document.getElementById('error_box').innerHTML = 'Please listen to <strong>Audio Segment ' + trackId + '</strong> for at least 5 seconds!';
            document.getElementById('error_box').scrollIntoView();
            return;
        } else {
            document.getElementById('f1_played').setAttribute('value', audio_played('f1'));
            document.getElementById('f2_played').setAttribute('value', audio_played('f2'));
            document.getElementById('f3_played').setAttribute('value', audio_played('f3'));
            document.getElementById('f4_played').setAttribute('value', audio_played('f4'));
            document.getElementById('f5_played').setAttribute('value', audio_played('f5'));

            document.getElementById('error_box').className = 'alert alert-success';
            document.getElementById('error_box').innerHTML = '<strong>Thank you for your work!</strong>';
        }
    });
</script>
